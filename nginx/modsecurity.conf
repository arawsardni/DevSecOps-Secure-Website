# Basic configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 1024

# Handling of file uploads
SecUploadDir /tmp
SecUploadFileMode 0644

# Debug log configuration
SecDebugLog /var/log/nginx/modsec_debug.log
SecDebugLogLevel 0

# Audit log configuration
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/nginx/modsec_audit.log

# Default action
SecDefaultAction "phase:1,log,auditlog,deny,status:403"

# Data files
SecDataDir /tmp

# Maximum request body size
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# HTTP policy restrictions
SecRule REQUEST_METHOD "^(?:CONNECT|TRACE)" "id:1000,phase:1,t:none,log,deny,msg:'Restricted HTTP Method'"

# Default character set
SecArgumentSeparator &
SecCookieFormat 0
# Disable unicode mapping until the file is available
# SecUnicodeMapFile unicode.mapping 20127

# Set various options for rule processing
SecRule TX:EXECUTING_PARANOIA_LEVEL "@lt 1" "id:1001,phase:1,pass,nolog,setvar:tx.executing_paranoia_level=1"

# Set paranoia level
SecAction \
  "id:900000,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.paranoia_level=1"

# Set anomaly scoring thresholds
SecAction \
  "id:900110,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.inbound_anomaly_score_threshold=5,\
   setvar:tx.outbound_anomaly_score_threshold=4"

# Allow specific backend URLs (whitelist example)
SecRule REQUEST_URI "@beginsWith /api/" "id:1002,phase:1,pass,nolog,ctl:ruleEngine=DetectionOnly"
SecRule REQUEST_URI "@beginsWith /admin/" "id:1003,phase:1,pass,nolog,ctl:ruleEngine=DetectionOnly"
SecRule REQUEST_URI "@beginsWith /static/" "id:1004,phase:1,pass,nolog,ctl:ruleEngine=Off"
SecRule REQUEST_URI "@beginsWith /media/" "id:1005,phase:1,pass,nolog,ctl:ruleEngine=Off" 